# Phase V Todo Chatbot - Docker Compose
# Usage: docker-compose up --build

services:
  # ─── Frontend (Next.js) ────────────────────────────────────
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - BACKEND_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - todo-network

  # ─── Backend (FastAPI) ─────────────────────────────────────
  backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - LOG_LEVEL=INFO
      - FRONTEND_URL=http://localhost:3000
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - NEON_CONNECTION_STRING=${NEON_CONNECTION_STRING:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - todo-network

  # ─── Notification Service ──────────────────────────────────
  notification:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    environment:
      - LOG_LEVEL=INFO
      - BACKEND_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - todo-network

  # ─── Recurring Task Service ────────────────────────────────
  recurring:
    build:
      context: ./services/recurring-task-service
      dockerfile: Dockerfile
    ports:
      - "8002:8002"
    environment:
      - LOG_LEVEL=INFO
      - BACKEND_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - todo-network

  # ─── Audit Service ────────────────────────────────────────
  audit:
    build:
      context: ./services/audit-service
      dockerfile: Dockerfile
    ports:
      - "8003:8003"
    environment:
      - LOG_LEVEL=INFO
      - BACKEND_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - todo-network

  # ─── WebSocket Service ────────────────────────────────────
  websocket:
    build:
      context: ./services/websocket-service
      dockerfile: Dockerfile
    ports:
      - "8004:8004"
    environment:
      - LOG_LEVEL=INFO
      - BACKEND_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - todo-network

networks:
  todo-network:
    driver: bridge
